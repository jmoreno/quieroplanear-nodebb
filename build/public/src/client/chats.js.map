{"version":3,"sources":["public/src/client/chats.js"],"names":["define","components","translator","mousetrap","recentChats","search","messages","Benchpress","Chats","initialised","newMessage","init","env","utils","findBootstrapEnvironment","addSocketListeners","addGlobalEventListeners","addEventListeners","createAutoComplete","$","resizeMainWindow","addHotkeys","document","ready","window","trigger","scrollToBottom","ajaxify","data","hasOwnProperty","get","focus","addSendHandlers","roomId","addPopoutHandler","addActionHandlers","addMemberHandler","find","addRenameHandler","addLeaveHandler","addScrollHandler","uid","addCharactersLeftHandler","addIPHandler","on","switchChat","container","ipEl","this","parent","mid","parents","attr","socket","emit","err","ip","app","alertError","html","text","val","previousUrl","match","go","userslug","openChat","history","one","el","loading","off","top","scrollHeight","height","scrollTop","start","parseInt","children","length","message","filter","chatMsg","messageId","parseMessage","currentScrollTop","previousHeight","prepend","timeago","addClass","element","updateRemainingLength","action","getAttribute","inputEl","prepEdit","delete","restore","bind","activeContact","prev","next","e","target","last","lastMid","buttonEl","modal","parse","translate","bootbox","dialog","title","refreshParticipantsList","addKickHandler","searchInput","errorEl","require","autocomplete","user","event","selected","username","item","name","translated","confirm","size","callback","ok","chatLib","close","users","listEl","parseAndTranslate","roomName","buttons","save","label","className","submit","newName","sendEl","which","shiftKey","sendMessage","strategies","options","zIndex","listPosition","position","$el","css","_applyPlacement","textcomplete","leave","remove","chat","getModal","roomid","url","self","fetch","config","relative_path","credentials","then","response","json","payload","setActive","pushState","location","protocol","host","console","warn","status","catch","error","appendChatMessage","template","chats","roomEl","recentEl","rooms","lastUser","fromUser","usernames","unread","updateUserStatus","onChatMessageEdit","titleEl","viewportHeight","fromTop","offset","toggleClass","removeClass"],"mappings":"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","file":"public/src/client/chats.js","sourcesContent":["'use strict';\n\n\ndefine('forum/chats', [\n\t'components',\n\t'translator',\n\t'mousetrap',\n\t'forum/chats/recent',\n\t'forum/chats/search',\n\t'forum/chats/messages',\n\t'benchpress',\n], function (components, translator, mousetrap, recentChats, search, messages, Benchpress) {\n\tvar Chats = {\n\t\tinitialised: false,\n\t};\n\n\tvar newMessage = false;\n\n\tChats.init = function () {\n\t\tvar env = utils.findBootstrapEnvironment();\n\n\t\tif (!Chats.initialised) {\n\t\t\tChats.addSocketListeners();\n\t\t\tChats.addGlobalEventListeners();\n\t\t}\n\n\t\trecentChats.init();\n\n\t\tChats.addEventListeners();\n\t\tChats.createAutoComplete($('[component=\"chat/input\"]'));\n\t\tChats.resizeMainWindow();\n\n\t\tif (env === 'md' || env === 'lg') {\n\t\t\tChats.addHotkeys();\n\t\t}\n\n\t\t$(document).ready(function () {\n\t\t\t$(window).trigger('action:chat.loaded', $('.chats-full'));\n\t\t});\n\n\t\tChats.initialised = true;\n\t\tmessages.scrollToBottom($('.expanded-chat ul.chat-content'));\n\n\t\tsearch.init();\n\n\t\tif (ajaxify.data.hasOwnProperty('roomId')) {\n\t\t\tcomponents.get('chat/input').focus();\n\t\t}\n\t};\n\n\tChats.addEventListeners = function () {\n\t\tChats.addSendHandlers(ajaxify.data.roomId, $('.chat-input'), $('.expanded-chat button[data-action=\"send\"]'));\n\t\tChats.addPopoutHandler();\n\t\tChats.addActionHandlers(components.get('chat/messages'), ajaxify.data.roomId);\n\t\tChats.addMemberHandler(ajaxify.data.roomId, components.get('chat/controls').find('[data-action=\"members\"]'));\n\t\tChats.addRenameHandler(ajaxify.data.roomId, components.get('chat/controls').find('[data-action=\"rename\"]'));\n\t\tChats.addLeaveHandler(ajaxify.data.roomId, components.get('chat/controls').find('[data-action=\"leave\"]'));\n\t\tChats.addScrollHandler(ajaxify.data.roomId, ajaxify.data.uid, $('.chat-content'));\n\t\tChats.addCharactersLeftHandler($('[component=\"chat/main-wrapper\"]'));\n\t\tChats.addIPHandler($('[component=\"chat/main-wrapper\"]'));\n\n\t\t$('[data-action=\"close\"]').on('click', function () {\n\t\t\tChats.switchChat();\n\t\t});\n\t};\n\n\tChats.addIPHandler = function (container) {\n\t\tcontainer.on('click', '.chat-ip-button', function () {\n\t\t\tvar ipEl = $(this).parent();\n\t\t\tvar mid = ipEl.parents('[data-mid]').attr('data-mid');\n\t\t\tsocket.emit('modules.chats.getIP', mid, function (err, ip) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err);\n\t\t\t\t}\n\t\t\t\tipEl.html(ip);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addPopoutHandler = function () {\n\t\t$('[data-action=\"pop-out\"]').on('click', function () {\n\t\t\tvar text = components.get('chat/input').val();\n\t\t\tvar roomId = ajaxify.data.roomId;\n\n\t\t\tif (app.previousUrl && app.previousUrl.match(/chats/)) {\n\t\t\t\tajaxify.go('user/' + ajaxify.data.userslug + '/chats', function () {\n\t\t\t\t\tapp.openChat(roomId, ajaxify.data.uid);\n\t\t\t\t}, true);\n\t\t\t} else {\n\t\t\t\twindow.history.go(-1);\n\t\t\t\tapp.openChat(roomId, ajaxify.data.uid);\n\t\t\t}\n\n\t\t\t$(window).one('action:chat.loaded', function () {\n\t\t\t\tcomponents.get('chat/input').val(text);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addScrollHandler = function (roomId, uid, el) {\n\t\tvar loading = false;\n\t\tel.off('scroll').on('scroll', function () {\n\t\t\tif (loading) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar top = (el[0].scrollHeight - el.height()) * 0.1;\n\t\t\tif (el.scrollTop() >= top) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tloading = true;\n\t\t\tvar start = parseInt(el.children('[data-mid]').length, 10);\n\t\t\tsocket.emit('modules.chats.getMessages', {\n\t\t\t\troomId: roomId,\n\t\t\t\tuid: uid,\n\t\t\t\tstart: start,\n\t\t\t}, function (err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tif (!data) {\n\t\t\t\t\tloading = false;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tdata = data.filter(function (chatMsg) {\n\t\t\t\t\treturn !$('[component=\"chat/message\"][data-mid=\"' + chatMsg.messageId + '\"]').length;\n\t\t\t\t});\n\t\t\t\tif (!data.length) {\n\t\t\t\t\tloading = false;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tmessages.parseMessage(data, function (html) {\n\t\t\t\t\tvar currentScrollTop = el.scrollTop();\n\t\t\t\t\tvar previousHeight = el[0].scrollHeight;\n\t\t\t\t\thtml = $(html);\n\t\t\t\t\tel.prepend(html);\n\t\t\t\t\thtml.find('.timeago').timeago();\n\t\t\t\t\thtml.find('img:not(.not-responsive)').addClass('img-responsive');\n\t\t\t\t\tel.scrollTop((el[0].scrollHeight - previousHeight) + currentScrollTop);\n\t\t\t\t\tloading = false;\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addCharactersLeftHandler = function (parent) {\n\t\tvar element = parent.find('[component=\"chat/input\"]');\n\t\telement.on('change keyup paste', function () {\n\t\t\tmessages.updateRemainingLength(parent);\n\t\t});\n\t};\n\n\tChats.addActionHandlers = function (element, roomId) {\n\t\telement.on('click', '[data-action]', function () {\n\t\t\tvar messageId = $(this).parents('[data-mid]').attr('data-mid');\n\t\t\tvar action = this.getAttribute('data-action');\n\n\t\t\tswitch (action) {\n\t\t\tcase 'edit':\n\t\t\t\tvar inputEl = $('[data-roomid=\"' + roomId + '\"] [component=\"chat/input\"]');\n\t\t\t\tmessages.prepEdit(inputEl, messageId, roomId);\n\t\t\t\tbreak;\n\n\t\t\tcase 'delete':\n\t\t\t\tmessages.delete(messageId, roomId);\n\t\t\t\tbreak;\n\n\t\t\tcase 'restore':\n\t\t\t\tmessages.restore(messageId, roomId);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addHotkeys = function () {\n\t\tmousetrap.bind('ctrl+up', function () {\n\t\t\tvar activeContact = $('.chats-list .bg-info');\n\t\t\tvar prev = activeContact.prev();\n\n\t\t\tif (prev.length) {\n\t\t\t\tChats.switchChat(prev.attr('data-roomid'));\n\t\t\t}\n\t\t});\n\t\tmousetrap.bind('ctrl+down', function () {\n\t\t\tvar activeContact = $('.chats-list .bg-info');\n\t\t\tvar next = activeContact.next();\n\n\t\t\tif (next.length) {\n\t\t\t\tChats.switchChat(next.attr('data-roomid'));\n\t\t\t}\n\t\t});\n\t\tmousetrap.bind('up', function (e) {\n\t\t\tif (e.target === components.get('chat/input').get(0)) {\n\t\t\t\t// Retrieve message id from messages list\n\t\t\t\tvar message = components.get('chat/messages').find('.chat-message[data-self=\"1\"]').last();\n\t\t\t\tvar lastMid = message.attr('data-mid');\n\t\t\t\tvar inputEl = components.get('chat/input');\n\n\t\t\t\tmessages.prepEdit(inputEl, lastMid, ajaxify.data.roomId);\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addMemberHandler = function (roomId, buttonEl) {\n\t\tvar modal;\n\n\t\tbuttonEl.on('click', function () {\n\t\t\tBenchpress.parse('partials/modals/manage_room', {}, function (html) {\n\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\tmodal = bootbox.dialog({\n\t\t\t\t\t\ttitle: '[[modules:chat.manage-room]]',\n\t\t\t\t\t\tmessage: html,\n\t\t\t\t\t});\n\n\t\t\t\t\tmodal.attr('component', 'chat/manage-modal');\n\n\t\t\t\t\tChats.refreshParticipantsList(roomId, modal);\n\t\t\t\t\tChats.addKickHandler(roomId, modal);\n\n\t\t\t\t\tvar searchInput = modal.find('input');\n\t\t\t\t\tvar errorEl = modal.find('.text-danger');\n\t\t\t\t\trequire(['autocomplete', 'translator'], function (autocomplete, translator) {\n\t\t\t\t\t\tautocomplete.user(searchInput, function (event, selected) {\n\t\t\t\t\t\t\terrorEl.text('');\n\t\t\t\t\t\t\tsocket.emit('modules.chats.addUserToRoom', {\n\t\t\t\t\t\t\t\troomId: roomId,\n\t\t\t\t\t\t\t\tusername: selected.item.user.name,\n\t\t\t\t\t\t\t}, function (err) {\n\t\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\t\ttranslator.translate(err.message, function (translated) {\n\t\t\t\t\t\t\t\t\t\terrorEl.text(translated);\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tChats.refreshParticipantsList(roomId, modal);\n\t\t\t\t\t\t\t\tsearchInput.val('');\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addKickHandler = function (roomId, modal) {\n\t\tmodal.on('click', '[data-action=\"kick\"]', function () {\n\t\t\tvar uid = parseInt(this.getAttribute('data-uid'), 10);\n\n\t\t\tsocket.emit('modules.chats.removeUserFromRoom', {\n\t\t\t\troomId: roomId,\n\t\t\t\tuid: uid,\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tChats.refreshParticipantsList(roomId, modal);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addLeaveHandler = function (roomId, buttonEl) {\n\t\tbuttonEl.on('click', function () {\n\t\t\tbootbox.confirm({\n\t\t\t\tsize: 'small',\n\t\t\t\ttitle: '[[modules:chat.leave]]',\n\t\t\t\tmessage: '<p>[[modules:chat.leave-prompt]]</p><p class=\"help-block\">[[modules:chat.leave-help]]</p>',\n\t\t\t\tcallback: function (ok) {\n\t\t\t\t\tif (ok) {\n\t\t\t\t\t\tsocket.emit('modules.chats.leave', roomId, function (err) {\n\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\tapp.alertError(err.message);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// Return user to chats page. If modal, close modal.\n\t\t\t\t\t\t\tvar modal = buttonEl.parents('.chat-modal');\n\t\t\t\t\t\t\tif (modal.length) {\n\t\t\t\t\t\t\t\trequire(['chat'], function (chatLib) {\n\t\t\t\t\t\t\t\t\tchatLib.close(modal);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tajaxify.go('chats');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.refreshParticipantsList = function (roomId, modal) {\n\t\tsocket.emit('modules.chats.getUsersInRoom', { roomId: roomId }, function (err, users) {\n\t\t\tvar listEl = modal.find('.list-group');\n\n\t\t\tif (err) {\n\t\t\t\treturn translator.translate('[[error:invalid-data]]', function (translated) {\n\t\t\t\t\tlistEl.find('li').text(translated);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tapp.parseAndTranslate('partials/modals/manage_room_users', {\n\t\t\t\tusers: users,\n\t\t\t}, function (html) {\n\t\t\t\tlistEl.html(html);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addRenameHandler = function (roomId, buttonEl, roomName) {\n\t\tvar modal;\n\n\t\tbuttonEl.on('click', function () {\n\t\t\tBenchpress.parse('partials/modals/rename_room', {\n\t\t\t\tname: roomName || ajaxify.data.roomName,\n\t\t\t}, function (html) {\n\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\tmodal = bootbox.dialog({\n\t\t\t\t\t\ttitle: '[[modules:chat.rename-room]]',\n\t\t\t\t\t\tmessage: html,\n\t\t\t\t\t\tbuttons: {\n\t\t\t\t\t\t\tsave: {\n\t\t\t\t\t\t\t\tlabel: '[[global:save]]',\n\t\t\t\t\t\t\t\tclassName: 'btn-primary',\n\t\t\t\t\t\t\t\tcallback: submit,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\tfunction submit() {\n\t\t\tsocket.emit('modules.chats.renameRoom', {\n\t\t\t\troomId: roomId,\n\t\t\t\tnewName: modal.find('#roomName').val(),\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n\n\tChats.addSendHandlers = function (roomId, inputEl, sendEl) {\n\t\tinputEl.off('keypress').on('keypress', function (e) {\n\t\t\tif (e.which === 13 && !e.shiftKey) {\n\t\t\t\tmessages.sendMessage(roomId, inputEl);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\n\t\tsendEl.off('click').on('click', function () {\n\t\t\tmessages.sendMessage(roomId, inputEl);\n\t\t\tinputEl.focus();\n\t\t\treturn false;\n\t\t});\n\t};\n\n\tChats.createAutoComplete = function (element) {\n\t\tvar data = {\n\t\t\telement: element,\n\t\t\tstrategies: [],\n\t\t\toptions: {\n\t\t\t\tzIndex: 20000,\n\t\t\t\tlistPosition: function (position) {\n\t\t\t\t\tthis.$el.css(this._applyPlacement(position));\n\t\t\t\t\tthis.$el.css('position', 'absolute');\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\n\t\t$(window).trigger('chat:autocomplete:init', data);\n\t\tif (data.strategies.length) {\n\t\t\tdata.element.textcomplete(data.strategies, data.options);\n\t\t}\n\t};\n\n\tChats.leave = function (el) {\n\t\tvar roomId = el.attr('data-roomid');\n\t\tsocket.emit('modules.chats.leave', roomId, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tif (parseInt(roomId, 10) === parseInt(ajaxify.data.roomId, 10)) {\n\t\t\t\tajaxify.go('user/' + ajaxify.data.userslug + '/chats');\n\t\t\t} else {\n\t\t\t\tel.remove();\n\t\t\t}\n\t\t\trequire(['chat'], function (chat) {\n\t\t\t\tvar modal = chat.getModal(roomId);\n\t\t\t\tif (modal.length) {\n\t\t\t\t\tchat.close(modal);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.switchChat = function (roomid) {\n\t\t// Allow empty arg for return to chat list/close chat\n\t\tif (!roomid) {\n\t\t\troomid = '';\n\t\t}\n\n\t\tvar url = 'user/' + ajaxify.data.userslug + '/chats/' + roomid;\n\t\tif (self.fetch) {\n\t\t\tfetch(config.relative_path + '/api/' + url, { credentials: 'include' })\n\t\t\t\t.then(function (response) {\n\t\t\t\t\tif (response.ok) {\n\t\t\t\t\t\tresponse.json().then(function (payload) {\n\t\t\t\t\t\t\tapp.parseAndTranslate('partials/chats/message-window', payload, function (html) {\n\t\t\t\t\t\t\t\tcomponents.get('chat/main-wrapper').html(html);\n\t\t\t\t\t\t\t\thtml.find('.timeago').timeago();\n\t\t\t\t\t\t\t\tChats.resizeMainWindow();\n\t\t\t\t\t\t\t\tajaxify.data = payload;\n\t\t\t\t\t\t\t\tChats.setActive();\n\t\t\t\t\t\t\t\tChats.addEventListeners();\n\t\t\t\t\t\t\t\t$(window).trigger('action:chat.loaded', $('.chats-full'));\n\t\t\t\t\t\t\t\tmessages.scrollToBottom($('.expanded-chat ul.chat-content'));\n\t\t\t\t\t\t\t\tif (history.pushState) {\n\t\t\t\t\t\t\t\t\thistory.pushState({\n\t\t\t\t\t\t\t\t\t\turl: 'user/' + payload.userslug + '/chats/' + payload.roomId,\n\t\t\t\t\t\t\t\t\t}, null, window.location.protocol + '//' + window.location.host + config.relative_path + '/user/' + payload.userslug + '/chats/' + payload.roomId);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn('[search] Received ' + response.status);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch(function (error) {\n\t\t\t\t\tconsole.warn('[search] ' + error.message);\n\t\t\t\t});\n\t\t} else {\n\t\t\tajaxify.go(url);\n\t\t}\n\t};\n\n\tChats.addGlobalEventListeners = function () {\n\t\t$(window).on('resize', Chats.resizeMainWindow);\n\t\t$(window).on('mousemove keypress click', function () {\n\t\t\tif (newMessage && ajaxify.data.roomId) {\n\t\t\t\tsocket.emit('modules.chats.markRead', ajaxify.data.roomId);\n\t\t\t\tnewMessage = false;\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addSocketListeners = function () {\n\t\tsocket.on('event:chats.receive', function (data) {\n\t\t\tif (parseInt(data.roomId, 10) === parseInt(ajaxify.data.roomId, 10)) {\n\t\t\t\tnewMessage = data.self === 0;\n\t\t\t\tdata.message.self = data.self;\n\n\t\t\t\tmessages.appendChatMessage($('.expanded-chat .chat-content'), data.message);\n\t\t\t} else if (ajaxify.data.template.chats) {\n\t\t\t\tvar roomEl = $('[data-roomid=' + data.roomId + ']');\n\n\t\t\t\tif (roomEl.length > 0) {\n\t\t\t\t\troomEl.addClass('unread');\n\t\t\t\t} else {\n\t\t\t\t\tvar recentEl = components.get('chat/recent');\n\t\t\t\t\tBenchpress.parse('partials/chats/recent_room', {\n\t\t\t\t\t\trooms: {\n\t\t\t\t\t\t\troomId: data.roomId,\n\t\t\t\t\t\t\tlastUser: data.message.fromUser,\n\t\t\t\t\t\t\tusernames: data.message.fromUser.username,\n\t\t\t\t\t\t\tunread: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t}, function (html) {\n\t\t\t\t\t\ttranslator.translate(html, function (translated) {\n\t\t\t\t\t\t\trecentEl.prepend(translated);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tsocket.on('event:user_status_change', function (data) {\n\t\t\tapp.updateUserStatus($('.chats-list [data-uid=\"' + data.uid + '\"] [component=\"user/status\"]'), data.status);\n\t\t});\n\n\t\tmessages.onChatMessageEdit();\n\n\t\tsocket.on('event:chats.roomRename', function (data) {\n\t\t\tvar roomEl = components.get('chat/recent/room', data.roomId);\n\t\t\tvar titleEl = roomEl.find('[component=\"chat/title\"]');\n\t\t\tajaxify.data.roomName = data.newName;\n\n\t\t\ttitleEl.text(data.newName);\n\t\t});\n\t};\n\n\tChats.resizeMainWindow = function () {\n\t\tvar viewportHeight = $(window).height();\n\t\tvar fromTop = components.get('chat/main-wrapper').offset().top || components.get('chat/nav-wrapper').offset().top;\n\t\t$('.chats-full').height(viewportHeight - fromTop - 1);\n\n\t\tChats.setActive();\n\t};\n\n\tChats.setActive = function () {\n\t\tif (ajaxify.data.roomId) {\n\t\t\tsocket.emit('modules.chats.markRead', ajaxify.data.roomId);\n\t\t\t$('[data-roomid=\"' + ajaxify.data.roomId + '\"]').toggleClass('unread', false);\n\t\t\t$('.expanded-chat [component=\"chat/input\"]').focus();\n\t\t}\n\t\t$('.chats-list li').removeClass('bg-info');\n\t\t$('.chats-list li[data-roomid=\"' + ajaxify.data.roomId + '\"]').addClass('bg-info');\n\n\t\tcomponents.get('chat/nav-wrapper').attr('data-loaded', ajaxify.data.roomId ? '1' : '0');\n\t};\n\n\n\treturn Chats;\n});\n"]}